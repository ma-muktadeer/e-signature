CREATE OR REPLACE VIEW VW_PASSWORD_REPORT AS
SELECT 
    ROWNUM AS ID_PASSWORD_REPORT_KEY,
    U.TX_FULL_NAME AS TX_USER_NAME, 
    U.TX_EMAIL,
    INS.TX_NAME AS TX_INSTITUTION_NAME,
    V.* FROM (
        --FOR SUCCESS (CHANGE PASS)
        SELECT PL.DTT_CREATE as DT_DATE_TIME , 'SUCCESS' AS TX_STATUS ,'PASSWORD_RESTE_DATE_TIME' AS TX_TYPE,OTP.ID_USER_KEY
            FROM T_PASSWORD_LIST PL,T_OTP OTP
            WHERE PL.ID_OBJECT_KEY=OTP.ID_OTP_KEY
            and OTP.tx_status='SUCCESSED' AND OTP.TX_OTP_TPYE='CHANGE_PASSWORD'
        --FOR FAIL (CHANGE PASS)
        union all
        SELECT PL.DTT_CREATE as DT_DATE_TIME , 'SUCCESS' AS TX_STATUS ,'ADMIN_RESET_PASSWORD' AS TX_TYPE,PL.ID_USER_KEY
            FROM T_PASSWORD_LIST PL
            WHERE PL.TX_TYPE='ADMIN_RESET_PASSWORD'
        UNION ALL
        SELECT OTP.DTT_CREATE as DT_DATE_TIME , 'FAILED' AS TX_STATUS ,'PASSWORD_RESTE_DATE_TIME' AS TX_TYPE,OTP.ID_USER_KEY
            FROM T_OTP OTP
            WHERE  OTP.tx_status='FAILED' AND OTP.TX_OTP_TPYE='CHANGE_PASSWORD'
        --SUCCESS (FORGET PASS)
        UNION ALL
        SELECT OTP.DTT_CREATE as DT_DATE_TIME,'SUCCESS' AS TX_STATUS,'FORGET_PASS' AS TX_TYPE,OTP.ID_USER_KEY
            FROM T_USER_LINK UL,T_OTP OTP
            WHERE UL.ID_OTP_KEY=OTP.ID_OTP_KEY
            and OTP.tx_status='SUCCESSED' AND OTP.TX_OTP_TPYE='FORGET_PASS' AND UL.TX_STATUS='SUCCESSED'
        UNION ALL
        --FAIL (FORGET PASS)
        SELECT OTP.DTT_CREATE as DT_DATE_TIME,'FAILED' AS TX_STATUS,'FORGET_PASS' AS TX_TYPE,OTP.ID_USER_KEY
            FROM T_OTP OTP
            WHERE OTP.tx_status='FAILED' AND OTP.TX_OTP_TPYE='FORGET_PASS' 
        UNION ALL
        --FAIL ANOTHER WAY(FORGET PASS)
        SELECT OTP.DTT_CREATE as DT_DATE_TIME,'FAILED' AS TX_STATUS,'FORGET_PASS' AS TX_TYPE,OTP.ID_USER_KEY
            FROM  T_USER_LINK UL,T_OTP OTP
            WHERE UL.ID_OTP_KEY=OTP.ID_OTP_KEY
            AND OTP.tx_status='SUCCESSED' AND OTP.TX_OTP_TPYE='FORGET_PASS'
            AND UL.TX_STATUS='FAILED'
         ) V, T_USER U, T_INSTITUTION INS
        WHERE V.ID_USER_KEY=U.ID_USER_KEY AND U.IS_ACTIVE=1
        AND U.ID_INSTITUTION_KEY = INS.ID_INSTITUTION_KEY
    ORDER BY V.DT_DATE_TIME DESC