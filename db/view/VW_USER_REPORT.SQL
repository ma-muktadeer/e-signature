-- CREATE OR REPLACE VIEW VE_USER_REPORT AS
-- SELECT ROWNUM AS ID_USER_KEY,B.TX_ADMIN_USER,
--  U.TX_LOGIN_NAME,U.TX_USER_TYPE,TO_CHAR(u.DTT_CREATE,'yyyy-mm-dd hh:mm') AS TX_USER_CREATE_DATE,
-- U.DTT_CREATE,
-- TO_CHAR(U.DTT_APPROVE,'yyyy-mm-dd hh:mm') AS TX_ACTIVE_DATE,
-- TO_CHAR(U.DTT_INACTIVE,'yyyy-mm-dd hh:mm') AS TX_INACTIVE_DATE,
-- CASE WHEN U.IS_ACTIVE=1 THEN 'UNLOCK' ELSE 'LOCK' END AS TX_USER_STATUS,
-- --TO_CHAR(U.DTT_MOD,'yyyy-mm-dd hh:mm') AS TX_AMEND_DATE,
-- U.DTT_MOD AS TX_AMEND_DATE,
-- (SELECT MAKER.TX_FULL_NAME FROM T_USER MAKER WHERE MAKER.ID_USER_KEY=U.ID_USER_CREATE_KEY AND ROWNUM=1 ) AS TX_MAKER,
-- (SELECT AUT.TX_FULL_NAME || '( ' || AUT.TX_LOGIN_NAME || ') '  FROM T_USER AUT WHERE AUT.ID_USER_KEY=U.ID_APPROVED_BY_ID AND ROWNUM=1 ) AS TX_AUTHORIZER ,
-- ( SELECT TO_CHAR(max(PC.DTT_CREATE),'YYYY-MM-DD HH:MM:SS')
--  FROM T_PASSWORD_LIST PC WHERE PC.ID_USER_KEY=U.ID_USER_KEY
--  AND PC.TX_TYPE='CHANGE_PASSWORD') as PASS_RESET_DATE_TIME,
--  (SELECT TO_CHAR(max(RD.DTT_CREATE),'YYYY-MM-DD HH:MM:SS')
--  FROM T_PASSWORD_LIST RD WHERE RD.ID_USER_KEY=U.ID_USER_KEY
--  AND RD.TX_TYPE='ADMIN_RESET_PASSWORD') as ADMIN_RESET_DATE_TIME,
--  U.TX_USER_BLOCK_CAUSE
--  FROM T_USER U 
--  LEFT JOIN
--  (
--     SELECT ID_PASSWORD_LIST_KEY, AU.ID_USER_MOD_KEY, UI.TX_FULL_NAME || '( ' || UI.TX_LOGIN_NAME || ') '  as TX_ADMIN_USER
--     FROM T_PASSWORD_LIST AU,T_USER UI WHERE AU.ID_USER_MOD_KEY=UI.ID_USER_KEY 
--     AND AU.TX_TYPE='ADMIN_RESET_PASSWORD' AND ROWNUM=1
--     ORDER BY AU.ID_PASSWORD_LIST_KEY DESC
--   ) B ON U.ID_USER_KEY=B.ID_USER_MOD_KEY;


CREATE OR REPLACE VIEW VE_USER_REPORT AS
SELECT ROWNUM AS ID_USER_KEY,
 U.TX_LOGIN_NAME,
 U.TX_FULL_NAME,
 U.TX_USER_TYPE,
 U.TX_USER_STATUS AS TX_BD_USER_STATUS,
 TO_CHAR(U.DTT_CREATE,'YYYY-MM-DD HH:MI') AS TX_USER_CREATE_DATE,
 TO_CHAR(U.DTT_MOD,'YYYY-MM-DD HH:MI') AS TX_AMEND_DATE_ST,
U.DTT_CREATE,
TO_CHAR(U.DTT_APPROVE,'YYYY-MM-DD HH:MI') AS TX_ACTIVE_DATE,
TO_CHAR(U.DTT_INACTIVE,'YYYY-MM-DD HH:MI') AS TX_INACTIVE_DATE,
CASE WHEN U.INT_ALLOW_LOGIN=1 THEN 'UNLOCK' ELSE 'LOCK' END AS TX_USER_STATUS,
--TO_CHAR(U.DTT_MOD,'YYYY-MM-DD HH:MM') AS TX_AMEND_DATE,
U.DTT_MOD AS TX_AMEND_DATE,
(SELECT MAKER.TX_FULL_NAME FROM T_USER MAKER WHERE MAKER.ID_USER_KEY=U.ID_USER_CREATE_KEY AND ROWNUM=1 ) AS TX_MAKER,
(SELECT AUT.TX_FULL_NAME || '( ' || AUT.TX_LOGIN_NAME || ') '  FROM T_USER AUT WHERE AUT.ID_USER_KEY=U.ID_APPROVED_BY_ID AND ROWNUM=1 ) AS TX_AUTHORIZER ,
TO_CHAR(VWP.DTT_CREATE, 'YYYY-MM-DD HH:MI:SS') AS PASS_RESET_DATE_TIME,
CASE
   WHEN VWP.TX_TYPE='ADMIN_RESET_PASSWORD' THEN TO_CHAR(VWP.DTT_CREATE, 'YYYY-MM-DD HH:MI:SS')
   END AS ADMIN_RESET_DATE_TIME,
CASE
   WHEN VWP.TX_TYPE='ADMIN_RESET_PASSWORD' THEN VWP.TX_MOD_USER
END AS TX_ADMIN_USER,
U.TX_USER_BLOCK_CAUSE,
U.TX_PHONE_NUMBER,
I.TX_NAME AS TX_INSTITUTE_NAME,
U.TX_DESIGNATION,
CASE WHEN U.TX_USER_TYPE='EXTERNAL_USER' THEN U.tx_ext_branch_name ELSE B.TX_BRANCH_NAME END AS TX_BRUNCH,
u.TX_EMPLOYEE_ID,
FN_LAST_LOGIN_TIME(U.ID_USER_KEY) AS LAST_LOGIN_DATE
FROM T_USER U 
LEFT JOIN VW_PASS_LIST_INFO VWP ON VWP.ID_USER_KEY = U.ID_USER_KEY
LEFT JOIN T_INSTITUTION I ON I.ID_INSTITUTION_KEY = U.ID_INSTITUTION_KEY
LEFT JOIN T_BRANCH B ON B.ID_BRANCH_ID=U.ID_LEGAL_ENTITY_KEY;
